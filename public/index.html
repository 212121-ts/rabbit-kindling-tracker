<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rabbit Kindling Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .auth-container {
            padding: 40px 20px;
            display: none;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .form-section {
            padding: 30px 20px;
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="date"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background: #e6ffe6;
            color: #2d7a2d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .results {
            padding: 0 20px 30px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .date-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .date-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .date-card h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .date-card p {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .date-card .note {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
            font-weight: normal;
        }

        .litter-info {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .litter-info h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .litter-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
        }

        .stat-box .number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-box .label {
            font-size: 12px;
            color: #666;
        }

        .saved-records {
            padding: 0 20px 30px;
            display: none;
        }

        .saved-records h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #667eea;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .export-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .record-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .record-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .record-info p {
            color: #666;
            font-size: 14px;
        }

        .record-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-edit {
            background: #4CAF50;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-small:hover {
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .rabbit-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 24px;
            }
            
            .date-card p {
                font-size: 20px;
            }

            .litter-stats {
                grid-template-columns: 1fr;
            }

            .user-info {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userEmail"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <h1><span>üê∞</span> Rabbit Kindling Tracker</h1>
            <p>Calculate breeding dates & track your rabbitry</p>
        </div>

        <!-- Authentication Section -->
        <div class="auth-container" id="authContainer">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Login</button>
                <button class="auth-tab" onclick="switchTab('register')">Register</button>
            </div>

            <div class="error-message" id="authError"></div>
            <div class="success-message" id="authSuccess"></div>

            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button class="btn-primary" onclick="handleLogin()">Login</button>
            </div>

            <!-- Register Form -->
            <div class="auth-form" id="registerForm">
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="licenseKey">License Key</label>
                    <input type="text" id="licenseKey" placeholder="XXXX-XXXX-XXXX-XXXX" style="text-transform: uppercase;" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password (min 6 characters)" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
                <button class="btn-primary" onclick="handleRegister()">Create Account</button>
            </div>
        </div>

        <!-- Main App Section -->
        <div class="form-section" id="mainApp">
            <div class="form-group">
                <label for="breedingDate">Breeding Date</label>
                <input type="date" id="breedingDate" required>
            </div>

            <div class="form-group">
                <label for="doesName">Doe's Name (Mama)</label>
                <input type="text" id="doesName" placeholder="Enter the mother rabbit's name" required>
            </div>

            <div class="form-group">
                <label for="buckName">Buck's Name</label>
                <input type="text" id="buckName" placeholder="Enter the father rabbit's name">
            </div>

            <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <input type="text" id="notes" placeholder="Any additional notes">
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="calculateDates()">Calculate Dates</button>
                <button class="btn-secondary" onclick="clearForm()">Clear</button>
            </div>
        </div>

        <div class="results" id="results"></div>

        <div class="saved-records" id="savedRecords">
            <h2>
                Saved Records
                <button class="export-button" onclick="exportToPDF()" id="exportBtn" style="display: none;">
                    üìÑ Export PDF
                </button>
            </h2>
            <div id="recordsList"></div>
        </div>
    </div>

    <!-- Modal for updating litter information -->
    <div id="litterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeLitterModal()">&times;</span>
                <h2>Update Litter Information</h2>
            </div>
            <div class="form-group">
                <label for="litterSize">Litter Size</label>
                <input type="number" id="litterSize" min="0" placeholder="Total number of kits">
            </div>
            <div class="form-group">
                <label for="maleCount">Male Count</label>
                <input type="number" id="maleCount" min="0" placeholder="Number of males">
            </div>
            <div class="form-group">
                <label for="femaleCount">Female Count</label>
                <input type="number" id="femaleCount" min="0" placeholder="Number of females">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="saveLitterInfo()">Save</button>
                <button class="btn-secondary" onclick="closeLitterModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
        
        // State Management
        let authToken = localStorage.getItem('authToken');
        let userEmail = localStorage.getItem('userEmail');
        let records = [];
        let currentEditingId = null;

        // Initialize app
        window.onload = function() {
            if (authToken) {
                showMainApp();
                loadRecords();
            } else {
                showAuthForm();
            }
            document.getElementById('breedingDate').value = new Date().toISOString().split('T')[0];
        };

        // Authentication Functions
        function showAuthForm() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('savedRecords').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('results').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('savedRecords').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userEmail').textContent = userEmail;
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update forms
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById(tab + 'Form').classList.add('active');
            
            // Clear messages
            hideMessages();
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(hideMessages, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(hideMessages, 5000);
        }

        function hideMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    userEmail = email;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userEmail', email);
                    showMainApp();
                    loadRecords();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const licenseKey = document.getElementById('licenseKey').value.toUpperCase();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !licenseKey || !password || !confirmPassword) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            // Validate license key format (more flexible)
            const keyPattern = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
            if (!keyPattern.test(licenseKey)) {
                showError('Invalid license key format');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, licenseKey })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    userEmail = email;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userEmail', email);
                    showSuccess('Account created successfully!');
                    setTimeout(() => {
                        showMainApp();
                        loadRecords();
                    }, 1500);
                } else {
                    showError(data.error || 'Registration failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                authToken = null;
                userEmail = null;
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                records = [];
                showAuthForm();
                clearForm();
            }
        }

        // Record Management Functions
        async function loadRecords() {
            try {
                const response = await fetch(`${API_URL}/api/records`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    records = data.records;
                    displayRecords();
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Failed to load records:', error);
            }
        }

        function calculateDates() {
            const breedingDate = document.getElementById('breedingDate').value;
            const doesName = document.getElementById('doesName').value;
            const buckName = document.getElementById('buckName').value;
            const notes = document.getElementById('notes').value;

            if (!breedingDate || !doesName) {
                alert('Please enter both breeding date and doe\'s name');
                return;
            }

            const breed = new Date(breedingDate);
            
            // Calculate all important dates
            const dates = {
                breeding: breed,
                nestbox: addDays(breed, 28),
                estDOB: addDays(breed, 32),
                turnBox: addDays(breed, 46),
                removeBox: addDays(breed, 53),
                rebreed: addDays(breed, 60),
                weanKits: addDays(breed, 72),
                sexDate: addDays(breed, 85)
            };

            // Display results
            displayResults(dates, doesName, buckName);

            // Save the record
            saveRecord({
                breeding_date: breedingDate,
                doe_name: doesName,
                buck_name: buckName,
                notes: notes
            });
        }

        async function saveRecord(record) {
            try {
                const response = await fetch(`${API_URL}/api/records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(record)
                });
                
                if (response.ok) {
                    loadRecords();
                    showSuccessMessage();
                } else {
                    alert('Failed to save record. Please try again.');
                }
            } catch (error) {
                console.error('Failed to save record:', error);
                alert('Network error. Please check your connection.');
            }
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function displayResults(dates, doesName, buckName, record = null) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            let litterInfoHtml = '';
            if (record && (record.litter_size || record.male_count || record.female_count)) {
                litterInfoHtml = `
                    <div class="litter-info">
                        <h3>üê£ Litter Information</h3>
                        <div class="litter-stats">
                            <div class="stat-box">
                                <div class="number">${record.litter_size || '‚Äî'}</div>
                                <div class="label">Total Kits</div>
                            </div>
                            <div class="stat-box">
                                <div class="number">${record.male_count || '‚Äî'}</div>
                                <div class="label">Males</div>
                            </div>
                            <div class="stat-box">
                                <div class="number">${record.female_count || '‚Äî'}</div>
                                <div class="label">Females</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = `
                <div class="date-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <h3>üê∞ Breeding Information</h3>
                    <p>${doesName} √ó ${buckName || 'Unknown Buck'}</p>
                    <p class="note">Bred on ${formatDate(dates.breeding)}</p>
                </div>

                ${litterInfoHtml}

                <div class="date-card">
                    <h3>üì¶ Add Nest Box</h3>
                    <p>${formatDate(dates.nestbox)}</p>
                    <p class="note">Day 28 - Prepare for kindling</p>
                </div>

                <div class="date-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <h3>üê£ Est. Date of Birth (DOB)</h3>
                    <p>${formatDate(dates.estDOB)}</p>
                    <p class="note">Day 32 - Expected kindling date</p>
                </div>

                <div class="date-card">
                    <h3>üîÑ Turn Box</h3>
                    <p>${formatDate(dates.turnBox)}</p>
                    <p class="note">Day 46 - Turn nest box on side</p>
                </div>

                <div class="date-card">
                    <h3>üì§ Remove Box</h3>
                    <p>${formatDate(dates.removeBox)}</p>
                    <p class="note">Day 53 - Remove nest box completely</p>
                </div>

                <div class="date-card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                    <h3>üíï Rebreed Doe</h3>
                    <p>${formatDate(dates.rebreed)}</p>
                    <p class="note">Day 60 - Doe ready for next breeding</p>
                </div>

                <div class="date-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <h3>üçº Wean Kits</h3>
                    <p>${formatDate(dates.weanKits)}</p>
                    <p class="note">Day 72 - Separate kits from mother</p>
                </div>

                <div class="date-card">
                    <h3>‚ôÇÔ∏è‚ôÄÔ∏è Sex Date</h3>
                    <p>${formatDate(dates.sexDate)}</p>
                    <p class="note">Day 85 - Determine gender & separate</p>
                </div>
            `;

            // Smooth scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showSuccessMessage() {
            const resultsDiv = document.getElementById('results');
            const successMsg = document.createElement('div');
            successMsg.className = 'date-card';
            successMsg.style.background = 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)';
            successMsg.innerHTML = '<h3>‚úÖ Record Saved Successfully!</h3>';
            resultsDiv.insertBefore(successMsg, resultsDiv.firstChild);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        function displayRecords() {
            const recordsList = document.getElementById('recordsList');
            const exportBtn = document.getElementById('exportBtn');
            
            if (records.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="rabbit-icon">üê∞</div>
                        <p>No records yet. Start by adding a breeding date!</p>
                    </div>
                `;
                exportBtn.style.display = 'none';
                return;
            }

            exportBtn.style.display = 'inline-block';
            recordsList.innerHTML = records.map(record => {
                const litterInfo = (record.litter_size || record.male_count || record.female_count) 
                    ? `<p style="font-size: 12px; color: #667eea;">Litter: ${record.litter_size || '?'} kits (${record.male_count || '?'}‚ôÇ ${record.female_count || '?'}‚ôÄ)</p>`
                    : '';
                
                return `
                    <div class="record-item">
                        <div class="record-header">
                            <div class="record-info">
                                <h4>${record.doe_name} √ó ${record.buck_name || 'Unknown Buck'}</h4>
                                <p>Bred: ${new Date(record.breeding_date).toLocaleDateString()}</p>
                                ${litterInfo}
                                ${record.notes ? `<p style="font-size: 12px; font-style: italic;">${record.notes}</p>` : ''}
                            </div>
                            <div class="record-actions">
                                <button class="btn-small btn-view" onclick="viewRecord(${record.id})">View</button>
                                <button class="btn-small btn-edit" onclick="openLitterModal(${record.id})">Litter</button>
                                <button class="btn-small btn-delete" onclick="deleteRecord(${record.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (record) {
                // Populate form
                document.getElementById('breedingDate').value = record.breeding_date;
                document.getElementById('doesName').value = record.doe_name;
                document.getElementById('buckName').value = record.buck_name || '';
                document.getElementById('notes').value = record.notes || '';
                
                // Calculate dates
                const breed = new Date(record.breeding_date);
                const dates = {
                    breeding: breed,
                    nestbox: addDays(breed, 28),
                    estDOB: addDays(breed, 32),
                    turnBox: addDays(breed, 46),
                    removeBox: addDays(breed, 53),
                    rebreed: addDays(breed, 60),
                    weanKits: addDays(breed, 72),
                    sexDate: addDays(breed, 85)
                };
                
                // Display results with litter info
                displayResults(dates, record.doe_name, record.buck_name, record);
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function openLitterModal(id) {
            currentEditingId = id;
            const record = records.find(r => r.id === id);
            
            if (record) {
                document.getElementById('litterSize').value = record.litter_size || '';
                document.getElementById('maleCount').value = record.male_count || '';
                document.getElementById('femaleCount').value = record.female_count || '';
            }
            
            document.getElementById('litterModal').style.display = 'block';
        }

        function closeLitterModal() {
            document.getElementById('litterModal').style.display = 'none';
            currentEditingId = null;
        }

        async function saveLitterInfo() {
            if (currentEditingId) {
                const litterSize = document.getElementById('litterSize').value;
                const maleCount = document.getElementById('maleCount').value;
                const femaleCount = document.getElementById('femaleCount').value;
                
                try {
                    const response = await fetch(`${API_URL}/api/records/${currentEditingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            litter_size: litterSize ? parseInt(litterSize) : null,
                            male_count: maleCount ? parseInt(maleCount) : null,
                            female_count: femaleCount ? parseInt(femaleCount) : null
                        })
                    });
                    
                    if (response.ok) {
                        loadRecords();
                        closeLitterModal();
                        alert('Litter information updated successfully!');
                    } else {
                        alert('Failed to update litter information.');
                    }
                } catch (error) {
                    console.error('Error updating litter info:', error);
                    alert('Network error. Please try again.');
                }
            }
        }

        async function deleteRecord(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                try {
                    const response = await fetch(`${API_URL}/api/records/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        loadRecords();
                    } else {
                        alert('Failed to delete record.');
                    }
                } catch (error) {
                    console.error('Error deleting record:', error);
                    alert('Network error. Please try again.');
                }
            }
        }

        function clearForm() {
            document.getElementById('breedingDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('doesName').value = '';
            document.getElementById('buckName').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('results').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == document.getElementById('litterModal')) {
                closeLitterModal();
            }
        }

        // Export to PDF function
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234); // Purple color
            doc.text('Rabbit Breeding Records', 105, 20, { align: 'center' });
            
            // Add user email and date
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`User: ${userEmail}`, 105, 30, { align: 'center' });
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 36, { align: 'center' });
            
            let yPosition = 50;
            const pageHeight = doc.internal.pageSize.height;
            
            // Sort records by breeding date (most recent first)
            const sortedRecords = [...records].sort((a, b) => 
                new Date(b.breeding_date) - new Date(a.breeding_date)
            );
            
            sortedRecords.forEach((record, index) => {
                // Check if we need a new page
                if (yPosition > pageHeight - 80) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Record header
                doc.setFontSize(14);
                doc.setTextColor(102, 126, 234);
                doc.text(`${record.doe_name} √ó ${record.buck_name || 'Unknown Buck'}`, 20, yPosition);
                
                yPosition += 8;
                
                // Breeding date
                doc.setFontSize(10);
                doc.setTextColor(60);
                doc.text(`Breeding Date: ${new Date(record.breeding_date).toLocaleDateString()}`, 20, yPosition);
                
                yPosition += 6;
                
                // Litter info if available
                if (record.litter_size || record.male_count || record.female_count) {
                    doc.text(`Litter: ${record.litter_size || '?'} kits (${record.male_count || '?'} males, ${record.female_count || '?'} females)`, 20, yPosition);
                    yPosition += 6;
                }
                
                // Notes if available
                if (record.notes) {
                    doc.setFontSize(9);
                    doc.setTextColor(80);
                    const lines = doc.splitTextToSize(`Notes: ${record.notes}`, 170);
                    lines.forEach(line => {
                        doc.text(line, 20, yPosition);
                        yPosition += 5;
                    });
                }
                
                // Important dates
                doc.setFontSize(9);
                doc.setTextColor(60);
                yPosition += 3;
                
                const breed = new Date(record.breeding_date);
                const dates = [
                    { label: 'Nestbox', date: addDays(breed, 28) },
                    { label: 'Est. DOB', date: addDays(breed, 32) },
                    { label: 'Turn Box', date: addDays(breed, 46) },
                    { label: 'Remove Box', date: addDays(breed, 53) },
                    { label: 'Rebreed', date: addDays(breed, 60) },
                    { label: 'Wean Kits', date: addDays(breed, 72) },
                    { label: 'Sex Date', date: addDays(breed, 85) }
                ];
                
                // Create two columns for dates
                dates.forEach((item, i) => {
                    const xPos = i < 4 ? 20 : 110;
                    const yPos = yPosition + ((i % 4) * 5);
                    doc.text(`${item.label}: ${item.date.toLocaleDateString()}`, xPos, yPos);
                });
                
                yPosition += 25;
                
                // Add separator line if not last record
                if (index < sortedRecords.length - 1) {
                    doc.setDrawColor(200);
                    doc.line(20, yPosition, 190, yPosition);
                    yPosition += 10;
                }
            });
            
            // Add footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Page ${i} of ${pageCount}`, 105, 280, { align: 'center' });
                doc.text('Rabbit Kindling Tracker', 20, 280);
            }
            
            // Save the PDF
            const fileName = `rabbit-breeding-records-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Handle Enter key for login/register forms
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                if (document.getElementById('loginForm').classList.contains('active')) {
                    handleLogin();
                } else if (document.getElementById('registerForm').classList.contains('active')) {
                    handleRegister();
                }
            }
        });
    </script>
</body>
</html>